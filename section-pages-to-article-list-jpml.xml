<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:media="http://search.yahoo.com/mrss" version="1.0">
   <xsl:output method="xml" encoding="UTF-8" indent="yes" />
   <xsl:variable name="smallcase" select="'abcdefghijklmnopqrstuvwxyz'" />
   <xsl:variable name="uppercase" select="'ABCDEFGHIJKLMNOPQRSTUVWXYZ'" />
   <xsl:template match="/pages">
      <jpml>
         <style src="GLOBAL_MODULES-stylesheet.ejs" />
         <style src="RIGHT_RAIL-stylesheet.ejs" />
         <panel class="main">
            <xsl:apply-templates />
         </panel>
      </jpml>
   </xsl:template>

   <xsl:template match="page[position() &gt; 2]/link[not(@class ='inline-deco' or @class ='deco')]">
      <box class="item">
         <p>
            <a class="item-link">
               <xsl:attribute name="href">
                  <xsl:value-of select="./@href" />
               </xsl:attribute>
	            <span class="item-title module_headline">
	               <xsl:value-of select="metadata/item[@key = 'headline']" />
	            </span>
	            <span class="break"><break/><break/></span>
		         <span class="item-summary body">
                  <xsl:variable name="summary" select="metadata/item[@key = 'summary']" />
                  <xsl:variable name="trimmed" select="substring($summary, 1, 200)" />
                  <xsl:call-template name="substring-before-last">
                     <xsl:with-param name="list" select="$trimmed"/>
                     <xsl:with-param name="delimiter" select="' '"/>
                  </xsl:call-template>
	            </span>
        	   </a>
         </p>
      </box>
   </xsl:template>
   <xsl:template match="link"/>

   <!--############################################################-->
   <!--## Template to determine Substring before last occurence  ##-->
   <!--## of a specific delemiter                                ##-->
   <!--############################################################-->
   <xsl:template name="substring-before-last">
   <!--passed template parameter -->
        <xsl:param name="list"/>
        <xsl:param name="delimiter"/>
        <xsl:choose>
            <xsl:when test="contains($list, $delimiter)">
      <!-- get everything in front of the first delimiter -->
                <xsl:value-of select="substring-before($list,$delimiter)"/>
                <xsl:choose>
                    <xsl:when test="contains(substring-after($list,$delimiter),$delimiter)">
                        <xsl:value-of select="$delimiter"/>
                    </xsl:when>
                </xsl:choose>
                <xsl:call-template name="substring-before-last">
                    <!-- store anything left in another variable -->
                    <xsl:with-param name="list" select="substring-after($list,$delimiter)"/>
                    <xsl:with-param name="delimiter" select="$delimiter"/>
                </xsl:call-template>
            </xsl:when>
        </xsl:choose>
    </xsl:template>

</xsl:stylesheet>